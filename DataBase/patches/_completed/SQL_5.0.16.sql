

Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.NotSelected', 'Не выбрано')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.CategoryId', 'Id')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.Name', 'Название')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.Slug', 'Урл синоним')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.ParentCategory', 'Id род. категории')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.SortOrder', 'Сортировка')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.Enabled', 'Активность')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.Hidden', 'Скрыта в меню')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.BriefDescription', 'Краткое описание')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.Description', 'Описание')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.DisplayStyle', 'Стиль отображения')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.Sorting', 'Сортировка товаров')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.DisplayBrandsInMenu', 'Отображать производителей в меню')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.DisplaySubCategoriesInMenu', 'Отображать в меню 2 уровня подкатегорий')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.Tags', 'Теги')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.Picture', 'Изображение')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.MiniPicture', 'Мини-картинка')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.Icon', 'Иконка для меню')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.SeoTitle', 'Сео тайтл')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.MetaKeywords', 'Сео слова')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.MetaDescription', 'Сео описание')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.H1', 'H1')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Core.ExportImport.CategoryFields.PropertyGroups', 'Группы свойств')

GO--

Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.NotSelected', 'Not selected')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.CategoryId', 'Id')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.Name', 'Name')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.Slug', 'Slug')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.ParentCategory', 'Parent category Id')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.SortOrder', 'Sorting')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.Enabled', 'Enabled')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.Hidden', 'Hide in menu')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.BriefDescription', 'Short description')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.Description', 'Description')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.DisplayStyle', 'Display style')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.Sorting', 'Product sorting')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.DisplayBrandsInMenu', 'Display brands in menu')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.DisplaySubCategoriesInMenu', 'Display sub categories in menu')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.Tags', 'Tags')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.Picture', 'Picture')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.MiniPicture', 'Mini picture')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.Icon', 'Icon')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.SeoTitle', 'Seo title')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.MetaKeywords', 'MetaKeywords')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.MetaDescription', 'MetaDescription')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.H1', 'H1')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Core.ExportImport.CategoryFields.PropertyGroups', 'Property groups')

GO--



Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Search.Index.NothingFound', 'К сожалению, по вашему запросу ничего не найдено')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Search.Index.NothingFound', 'Nothing found for your search request')



Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Js.Reviews.SuccessTitle', 'Спасибо!')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Js.Reviews.SuccessTitle', 'Thank you!')


GO--


ALTER PROCEDURE [Catalog].[PreCalcProductParamsMass] 
	@ModerateReviews BIT
AS 
BEGIN    
	SET NOCOUNT ON;    
	INSERT INTO [Catalog].[ProductExt] (ProductId,CountPhoto,PhotoId,VideosAvailable,MaxAvailable,NotSamePrices,MinPrice,Colors,AmountSort,OfferId,Comments,CategoryId)    
	  (SELECT ProductId, 0, NULL, 0, 0, 0, 0, NULL, 0, NULL, 0, NULL    
	   FROM [Catalog].Product    
	   WHERE Product.ProductId NOT IN (SELECT ProductId FROM [Catalog].[ProductExt]))    
	           
	UPDATE [Catalog].[ProductExt]    
	SET [CountPhoto] =    
		(SELECT Top(1) CASE    
		 WHEN Offer.ColorID IS NOT NULL THEN    
	   (SELECT Count(PhotoId)    
		FROM [Catalog].[Photo]    
		WHERE ([Photo].ColorID = Offer.ColorID    
		 OR [Photo].ColorID IS NULL)    
		  AND [Photo].[ObjId] = [ProductExt].ProductId    
		  AND TYPE = 'Product')    
		 ELSE    
	   (SELECT Count(PhotoId)    
		FROM [Catalog].[Photo]    
		WHERE [Photo].[ObjId] = [ProductExt].ProductId    
		  AND TYPE = 'Product')    
		END    
	  FROM [Catalog].[Offer]    
	  WHERE [ProductID] = [ProductExt].ProductId AND main =1),    
	        
		[PhotoId] =    
		(SELECT Top(1) CASE    
		 WHEN Offer.ColorID IS NOT NULL and amount <> 0 and price> 0 THEN    
	   (SELECT TOP (1) PhotoId    
		FROM [Catalog].[Photo]    
		WHERE ([Photo].ColorID = Offer.ColorID    
		 OR [Photo].ColorID IS NULL)    
		  AND [Photo].[ObjId] = [ProductExt].ProductId    
		  AND TYPE = 'Product'    
		ORDER BY main DESC, [Photo].[PhotoSortOrder],[PhotoId])    
		 ELSE    
	   (SELECT TOP (1) PhotoId    
		FROM [Catalog].[Photo]    
		WHERE [Photo].[ObjId] = [ProductExt].ProductId    
		  AND TYPE = 'Product'    
		ORDER BY main DESC ,[Photo].[PhotoSortOrder])    
		END    
	  FROM [Catalog].[Offer]    
	  WHERE [ProductID] = [ProductExt].ProductId AND main =1),    
	        
		[VideosAvailable] =    
		(SELECT Top(1) CASE    
		 WHEN COUNT(ProductVideoID) > 0 THEN 1    
		 ELSE 0    
		END    
	  FROM [Catalog].[ProductVideo]    
	  WHERE ProductID = [ProductExt].ProductId)    
	        
		,[MaxAvailable] = (  
	  SELECT Max(Offer.Amount)   
	  FROM [Catalog].Offer  
	  WHERE ProductId = [ProductExt].ProductId  
	  )  
	        
		,[NotSamePrices] =    
		(SELECT Top(1) CASE    
		 WHEN max(price) - min(price) > 0 THEN 1    
		 ELSE 0    
		END    
	  FROM [Catalog].offer    
	  WHERE offer.productid = [ProductExt].ProductId and price >0),    
	        
		[MinPrice] = (SELECT min(price) FROM [Catalog].offer WHERE offer.productid = [ProductExt].ProductId and price >0),    
	       
	 [PriceTemp] =    
		(SELECT ([MinPrice] - [MinPrice] * [Product].Discount / 100) * CurrencyValue       
		 FROM catalog.product   
		 inner join catalog.Currency on product.currencyid = Currency.currencyid    
		 WHERE product.productid = [ProductExt].ProductId),    
	    
		[Colors] = (SELECT [Settings].[ProductColorsToString]([ProductExt].ProductId)),    
	       
		[AmountSort] =    
		(SELECT Top(1) CASE    
		 WHEN MaxAvailable <= 0    
		OR MaxAvailable < IsNull(Product.MinAmount, 0) THEN 0    
		 ELSE 1    
		END    
	  FROM [Catalog].Offer    
	  INNER JOIN [Catalog].Product ON Product.ProductId = Offer.ProductId    
	  WHERE Offer.ProductId = [ProductExt].ProductId AND main = 1),    
	       
		[OfferId] =    
		(SELECT Top(1) OfferID    
	  FROM [Catalog].offer    
	  WHERE offer.productid = [ProductExt].ProductId AND (offer.Main = 1 OR offer.Main IS NULL)),    
	     
	 [Comments] =     
		(SELECT Count(ReviewId) From CMS.Review Where EntityId = [ProductExt].ProductId And (Checked = 1 Or @ModerateReviews = 0)),    
	       
	 [Gifts] =    
		(SELECT Top(1) CASE    
		 WHEN COUNT(ProductID) > 0 THEN 1    
		 ELSE 0    
		END    
	  FROM [Catalog].[ProductGifts]    
	  WHERE ProductID = [ProductExt].ProductId),    
	     
	 -- 1. get main category of product, 2. get root category by main category    
	 [CategoryId] =        
		(Select Top 1 id From [Settings].[GetParentsCategoryByChild]((SELECT top 1 CategoryID FROM [Catalog].ProductCategories WHERE ProductID = [ProductExt].ProductId ORDER BY Main DESC)) Order by sort desc)    
END    

GO--



ALTER PROCEDURE [Catalog].[PreCalcProductParams] 
	@productId INT,
	@ModerateReviews BIT
AS      
BEGIN      
 SET NOCOUNT ON;      
      
 DECLARE @CountPhoto INT      
 DECLARE @Type NVARCHAR(10)      
 DECLARE @PhotoId INT      
 DECLARE @MaxAvailable float      
 DECLARE @VideosAvailable BIT      
 DECLARE @Colors NVARCHAR(max)      
 DECLARE @NotSamePrices BIT      
 DECLARE @MinPrice FLOAT    
 DECLARE @PriceTemp FLOAT       
 DECLARE @AmountSort BIT      
 DECLARE @OfferId int      
 DECLARE @Comments int    
 DECLARE @CategoryId int    
 DECLARE @Gifts bit    
       
 if not exists(select  ProductID from [Catalog].Product where ProductID=@productId)      
 return      
      
 SET @Type = 'Product'      
 --@CountPhoto      
 SET @CountPhoto = (      
   SELECT CASE       
     WHEN Offer.ColorID IS NOT NULL      
      THEN (      
        SELECT Count(PhotoId)      
        FROM [Catalog].[Photo]      
        WHERE (      
          [Photo].ColorID = Offer.ColorID      
          OR [Photo].ColorID IS NULL      
          )      
         AND [Photo].[ObjId] = @productId      
         AND Type = @Type      
        )      
     ELSE (      
       SELECT Count(PhotoId)      
       FROM [Catalog].[Photo]      
       WHERE [Photo].[ObjId] = @productId      
        AND Type = @Type      
       )      
     END      
   FROM [Catalog].[Offer]      
   WHERE [ProductID] = @productId and main =1      
   )      
 --@PhotoId      
 SET @PhotoId = (      
   SELECT CASE       
     WHEN Offer.ColorID IS NOT NULL and amount <> 0 and price> 0   
      THEN (      
        SELECT TOP (1) PhotoId      
        FROM [Catalog].[Photo]      
        WHERE (      
          [Photo].ColorID = Offer.ColorID      
          OR [Photo].ColorID IS NULL      
          )      
         AND [Photo].[ObjId] = @productId      
         AND Type = @Type      
        ORDER BY main DESC      
         ,[Photo].[PhotoSortOrder]      
        )      
     ELSE (      
       SELECT TOP (1) PhotoId      
       FROM [Catalog].[Photo]      
       WHERE [Photo].[ObjId] = @productId      
        AND Type = @Type      
        ORDER BY main DESC      
         ,[Photo].[PhotoSortOrder]  
         ,[PhotoId]  
       )      
     END      
   FROM [Catalog].[Offer]       
   WHERE [ProductID] = @productId and main =1      
   )       
 --VideosAvailable      
 IF (      
   SELECT COUNT(ProductVideoID)      
   FROM [Catalog].[ProductVideo]      
   WHERE ProductID = @productId      
   ) > 0      
 BEGIN      
  SET @VideosAvailable = 1      
 END      
 ELSE      
 BEGIN      
  SET @VideosAvailable = 0      
 END      
      
 --@MaxAvailable      
SET @MaxAvailable = (SELECT Max(Offer.Amount)  
   FROM [Catalog].Offer  
   WHERE ProductId = @productId)   
      
 --AmountSort      
 SET @AmountSort = (      
   SELECT CASE       
     WHEN @MaxAvailable <= 0      
      OR @MaxAvailable < IsNull(Product.MinAmount, 0)      
      THEN 0      
     ELSE 1      
     END      
   FROM [Catalog].Offer inner join [Catalog].Product on Product.ProductId=Offer.ProductId      
   WHERE Offer.ProductId = @productId      
    AND main = 1      
   )      
 --Colors      
 SET @Colors = (      
   SELECT [Settings].[ProductColorsToString](@productId)      
   )      
      
 --@NotSamePrices      
 IF (      
   SELECT max(price) - min(price)      
   FROM [Catalog].offer      
   WHERE offer.productid = @productId and price > 0   
   ) > 0      
 BEGIN      
  SET @NotSamePrices = 1      
 END      
 ELSE      
 BEGIN      
  SET @NotSamePrices = 0      
 END      
  
 --@MinPrice      
 SET @MinPrice = (      
   SELECT min(price)      
   FROM CATALOG.offer      
   WHERE offer.productid = @productId and price > 0   
   )      
  
 --@OfferId    
 SET @OfferId = (SELECT OfferID      
   FROM CATALOG.offer      
   WHERE offer.productid = @productId and (offer.Main = 1 OR offer.Main IS NULL))     
  
  
 --@PriceTemp      
 SET @PriceTemp = (      
   SELECT (@MinPrice - @MinPrice * [Product].Discount / 100) * CurrencyValue       
   FROM Catalog.Product   
   inner join Catalog.Currency on Product.Currencyid = Currency.Currencyid    
   WHERE Product.Productid = @productId  
   )      
  
 --@Comments    
 SET @Comments = (    
 SELECT Count(ReviewId) From CMS.Review Where EntityId = @productId And (Checked = 1 or @ModerateReviews = 0)  
 )     
       
--@Gifts    
SET @Gifts =    
   (SELECT Top(1) CASE WHEN COUNT(ProductID) > 0 THEN 1 ELSE 0 END    
    FROM [Catalog].[ProductGifts]    
    WHERE ProductID = @productId)    
     
 --@CategoryId    
 Declare @MainCategoryId int    
 SET @MainCategoryId = (SELECT top 1 CategoryID FROM [Catalog].ProductCategories WHERE ProductID = @productId ORDER BY Main DESC)    
 IF @MainCategoryId IS NOT NULL    
 BEGIN    
 SET @CategoryId = (    
  Select Top 1 id From [Settings].[GetParentsCategoryByChild](@MainCategoryId) Order by sort desc    
 )    
 END    
      
 IF (      
   SELECT Count(productid)      
   FROM [Catalog].ProductExt      
   WHERE productid = @productId      
   ) > 0      
 BEGIN      
  UPDATE [Catalog].[ProductExt]      
  SET [CountPhoto] = @CountPhoto      
   ,[PhotoId] = @PhotoId         
   ,[VideosAvailable] = @VideosAvailable      
   ,[MaxAvailable] = @MaxAvailable      
   ,[NotSamePrices] = @NotSamePrices      
   ,[MinPrice] = @MinPrice      
   ,[Colors] = @Colors      
   ,[AmountSort] = @AmountSort      
   ,[OfferId] = @OfferId    
   ,[Comments] = @Comments     
   ,[CategoryId] = @CategoryId    
   ,[PriceTemp] = @PriceTemp    
   ,[Gifts] = @Gifts    
  WHERE [ProductId] = @productId      
 END      
 ELSE      
 BEGIN      
  INSERT INTO [Catalog].[ProductExt] (      
    [ProductId]      
   ,[CountPhoto]      
   ,[PhotoId]         
   ,[VideosAvailable]      
   ,[MaxAvailable]      
   ,[NotSamePrices]      
   ,[MinPrice]      
   ,[Colors]      
   ,[AmountSort]      
   ,[OfferId]    
   ,[Comments]    
   ,[CategoryId]    
   ,[PriceTemp]    
   ,[Gifts]    
   )      
  VALUES (      
    @productId      
   ,@CountPhoto      
   ,@PhotoId      
   ,@VideosAvailable      
   ,@MaxAvailable      
   ,@NotSamePrices      
   ,@MinPrice      
   ,@Colors      
   ,@AmountSort      
   ,@OfferId    
   ,@Comments    
   ,@CategoryId    
   ,@PriceTemp    
   ,@Gifts    
   )      
 END      
END     


GO--



IF EXISTS (select * from dbo.sysobjects where id = object_id(N'Catalog.sp_UpdateProductPropertyWithSort') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE Catalog.sp_UpdateProductPropertyWithSort
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_SubscribeDeleteEmail]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[sp_SubscribeDeleteEmail]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_SubscribeGetDectivateCodeByEmail]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[sp_SubscribeGetDectivateCodeByEmail]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_SubscribeGetEmailCountByActivateCode]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[sp_SubscribeGetEmailCountByActivateCode]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_SubscribeGetEmailCountByDeactivateCode]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[sp_SubscribeGetEmailCountByDeactivateCode]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_SubscribeGetEmailCountByEmail]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[sp_SubscribeGetEmailCountByEmail]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_SubscribeInsertDeactivateReason]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[sp_SubscribeInsertDeactivateReason]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_SubscribeInsertEmail]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[sp_SubscribeInsertEmail]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_SubscribeUpdateEnableByActivateCode]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [dbo].[sp_SubscribeUpdateEnableByActivateCode]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Catalog].[sp_AddProductPhoto]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Catalog].[sp_AddProductPhoto]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Order].[sp_GetCurrencyValueByISO3]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Order].[sp_GetCurrencyValueByISO3]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Order].[sp_GetOrderAvg]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Order].[sp_GetOrderAvg]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Catalog].[sp_UpdateProductPhoto]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Catalog].[sp_UpdateProductPhoto]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Order].[sp_GetOrderItemsNames]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Order].[sp_GetOrderItemsNames]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Order].[sp_GetOrders]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Order].[sp_GetOrders]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Order].[sp_GetPaymentModuleNameByPaymentTypeID]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Order].[sp_GetPaymentModuleNameByPaymentTypeID]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Order].[sp_GetTempOrders]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Order].[sp_GetTempOrders]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Order].[sp_UpdateShippingModuleSettingValue]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Order].[sp_UpdateShippingModuleSettingValue]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Order].[sp_UpdateTEMPOrder]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Order].[sp_UpdateTEMPOrder]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_GetModuleEnableState]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_GetModuleEnableState]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_GetModuleIDByModuleStringID]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_GetModuleIDByModuleStringID]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_GetModuleSettings]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_GetModuleSettings]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_GetModuleSettings_ByModuleKey]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_GetModuleSettings_ByModuleKey]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_GetPdaPage]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_GetPdaPage]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_GetShippingModuleEnableState]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_GetShippingModuleEnableState]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_GetShippingModuleSettings]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_GetShippingModuleSettings]
GO--

/* Oo
   Author: Puzurey Konstantine
   Company: ITM Company
   Date: 28.05.2007
*/
IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_GetWapPage]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_GetWapPage]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_UpdateModuleEnableState]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_UpdateModuleEnableState]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_UpdatePaymentModuleSettingValue]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_UpdatePaymentModuleSettingValue]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_UpdateShippingModuleEnableState]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_UpdateShippingModuleEnableState]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Settings].[sp_UpdateShippingModuleSettings]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Settings].[sp_UpdateShippingModuleSettings]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Catalog].[sp_GetCertificates]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Catalog].[sp_GetCertificates]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Catalog].[sp_DeleteProductPhoto]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Catalog].[sp_DeleteProductPhoto]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Catalog].[sp_GetCOUNTProductDiscussionByCode]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Catalog].[sp_GetCOUNTProductDiscussionByCode]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Catalog].[sp_GetOfferListID]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Catalog].[sp_GetOfferListID]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Catalog].[sp_GetProductPhoto]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Catalog].[sp_GetProductPhoto]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[CMS].[sp_UpdateMenuItemByItemId]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [CMS].[sp_UpdateMenuItemByItemId]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Order].[sp_DeleteOrderItem]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Order].[sp_DeleteOrderItem]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Order].[sp_DeleteTEMPOrder]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Order].[sp_DeleteTEMPOrder]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Catalog].[sp_SetProductTax]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Catalog].[sp_SetProductTax]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Catalog].[sp_TaxSelectCategory]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Catalog].[sp_TaxSelectCategory]
GO--

IF EXISTS (select * from dbo.sysobjects where id = object_id(N'[Catalog].[sp_UnSetProductTax]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
	DROP PROCEDURE [Catalog].[sp_UnSetProductTax]
GO--


ALTER TABLE [order].[order] ADD CustomData NVARCHAR(MAX)

GO--

ALTER FUNCTION [Settings].[CountChildCategoryBrand] (@ParentId int, @brandID int)
RETURNS int
AS
BEGIN
 declare @tbl Table (id int, productId int)
 declare @count int
 ;WITH Hierarchycte (id) AS
      (
      SELECT CategoryID FROM [Catalog].[Category] WHERE CategoryID = @ParentId 
      union ALL
      SELECT CategoryID FROM [Catalog].[Category] INNER JOIN hierarchycte ON [Category].ParentCategory = hierarchycte.id and CategoryID<>0
			and [Category].enabled = 1
      )
      
      insert @tbl Select hierarchycte.id, Product.ProductId --count(hierarchycte.id) as ProductCount
      from hierarchycte
        inner join Catalog.ProductCategories on ProductCategories.CategoryID = hierarchycte.id
		inner join Catalog.Product on Product.ProductID = ProductCategories.ProductID
		Where Product.brandID=@brandID and Product.Enabled=1 and Product.CategoryEnabled = 1
		group by  hierarchycte.id, Product.ProductId
      Set @count = (Select count(distinct productId) from @tbl)
      --Set @count = (Select SUM(brandCount) from @tbl)
      
      Return @count
END

GO--


ALTER PROCEDURE [Catalog].[sp_GetChildCategoriesByParentIDForMenu]
	@CurrentCategoryID int
AS
BEGIN
	
	IF (Select COUNT(CategoryID) From Catalog.Category Where ParentCategory = @CurrentCategoryID and Enabled = 1) > 0 
		BEGIN
			SELECT 
				[CategoryID],
				[Name],
				[Description],
				[BriefDescription],
				[ParentCategory],
				--[Picture],
				[Products_Count],
				[Total_Products_Count],
				[SortOrder],
				[Enabled],
				[Hidden],
				--[MiniPicture],
				[DisplayStyle],	
				[DisplayBrandsInMenu],
				[DisplaySubCategoriesInMenu],
				[UrlPath],
				(SELECT Count(CategoryID) FROM [Catalog].[Category] AS c WHERE c.ParentCategory = cat.CategoryID and Enabled = 1) AS [ChildCategories_Count] 
			FROM [Catalog].[Category] AS cat 
			WHERE [ParentCategory] = @CurrentCategoryID AND CategoryID <> 0 and Enabled = 1 AND HirecalEnabled = 1
			ORDER BY SortOrder, Name
		END
	ELSE
		BEGIN
			SELECT 
				[CategoryID],
				[Name],
				[Description],
				[BriefDescription],
				[ParentCategory],
				--[Picture],
				[Products_Count],
				[Total_Products_Count],
				[SortOrder],
				[Enabled],
				[Hidden],
				--[MiniPicture],
				[DisplayStyle],	
				[DisplayBrandsInMenu],
				[DisplaySubCategoriesInMenu],				
				[UrlPath],
				(SELECT Count(CategoryID) FROM [Catalog].[Category] AS c WHERE c.ParentCategory = cat.CategoryID and Enabled = 1) AS [ChildCategories_Count] 
			FROM [Catalog].[Category] AS cat WHERE [ParentCategory] = (Select ParentCategory From Catalog.Category 
			Where CategoryID = @CurrentCategoryID) AND CategoryID <> 0 and Enabled = 1 AND HirecalEnabled = 1
			ORDER BY SortOrder, Name
		END

END

GO--


ALTER PROCEDURE [Catalog].[sp_GetPropertyValuesByProductID] @ProductID INT  
AS  
BEGIN  
 SET NOCOUNT ON;  
  
 SELECT  
   [PropertyValue].[PropertyValueID]  
  ,[PropertyValue].[PropertyID]  
  ,[PropertyValue].[Value]  
  ,[PropertyValue].[SortOrder]  
  ,[Property].UseinFilter  
  ,[Property].UseIndetails  
  ,[Property].UseInBrief  
  ,[Property].[Name] as PropertyName  
  ,[Property].[SortOrder] as PropertySortOrder  
  ,[Property].[Expanded] as Expanded  
  ,[Property].[Type] as [Type]  
  ,[Property].GroupId as GroupId  
  ,[Property].[Description] as [Description]
  ,GroupName  
  ,GroupSortorder  
 FROM [Catalog].[PropertyValue]  
 INNER JOIN [Catalog].[ProductPropertyValue] ON [ProductPropertyValue].[PropertyValueID] = [PropertyValue].[PropertyValueID]  
 inner join [Catalog].[Property] on [Property].[PropertyID] = [PropertyValue].[PropertyID]  
 left join Catalog.PropertyGroup on propertyGroup.PropertyGroupID = [Property].GroupID  
 WHERE [ProductID] = @ProductID  
 ORDER BY case when PropertyGroup.GroupSortOrder is null then 1 else 0 end, 
 PropertyGroup.GroupSortOrder,PropertyGroup.GroupName, [Property].[SortOrder], [Property].Name, [PropertyValue].[SortOrder], [PropertyValue].Value  
END

GO--


ALTER PROCEDURE [Catalog].[sp_GetPropertyValuesByPropertyID] @PropertyID INT
AS
BEGIN
	SET NOCOUNT ON;

	SELECT [PropertyValueID]
		,[Property].[PropertyID]
		,[Value]
		,[PropertyValue].[SortOrder]
		,[Property].UseinFilter
		,[Property].UseIndetails
		,[Property].UseInBrief
		,Property.NAME AS PropertyName
		,Property.SortOrder AS PropertySortOrder
		,Property.Expanded
		,Property.[Type]
		,Property.[Description]
		,GroupId
		,GroupName
		,GroupSortorder
	FROM [Catalog].[PropertyValue]
	INNER JOIN [Catalog].[Property] ON [Property].[PropertyID] = [PropertyValue].[PropertyID]
	LEFT JOIN [Catalog].PropertyGroup ON PropertyGroup.PropertyGroupID = [Property].GroupID
	WHERE [Property].[PropertyID] = @PropertyID
	order by [PropertyValue].[SortOrder]
END

GO--


Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (1, 'Mobile.Product.ProductPhotos.GiftsTitle', 'Подарки')
Insert into [Settings].[Localization] ([LanguageId],[ResourceKey],[ResourceValue]) Values (2, 'Mobile.Product.ProductPhotos.GiftsTitle', 'Gifts')

UPDATE [Settings].[InternalSettings] SET [settingValue] = '5.0.16' WHERE [settingKey] = 'db_version'

